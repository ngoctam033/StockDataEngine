<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/14.6.3/nouislider.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/14.6.3/nouislider.min.js"></script>
    <title>My Web Page</title>
</head>
<body>
    <h1>Welcome to My Web Page</h1>
    <p>This is a simple HTML file served by an Express.js server.</p>
    <style>
        #lineChart {
            display: block;
            box-sizing: border-box;
            width: 1000px; /* CSS width */
            height: 500px; /* CSS height */
        }
    </style>
    <canvas id="lineChart" width="1000" height="500"></canvas>
    <div id="slider"></div>
    <!-- taoj script để kết nối đến websocket -->
    <script>
        // Tạo một thẻ canvas để vẽ biểu đồ
        const ctx = document.getElementById('lineChart').getContext('2d');
        // Tạo biểu đồ line chart
        const lineChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [], // Nhãn trục x (thời gian)
                datasets: [{
                    label: 'Stock Price',
                    data: [], // Dữ liệu giá cổ phiếu
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1,
                    fill: false
                }]
            },
            options: {
                responsive: false, // Tắt tính năng responsive để giữ nguyên kích thước
                maintainAspectRatio: false, // Tắt tính năng duy trì tỷ lệ khung hình
                animation: {
                    duration: 1000, // Thời gian chuyển đổi giữa các frame
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'minute'
                        },
                        title: {
                            display: true,
                            text: 'Time'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Price'
                        }
                    }
                },
                plugins: {
                    zoom: {
                        pan: {
                            enabled: true,
                            mode: 'xy'
                        },
                        zoom: {
                                wheel: {
                                    enabled: true // Sử dụng chuột để zoom
                                },
                                drag: {
                                    enabled: true // Sử dụng kéo để zoom
                                },
                                pinch: {
                                    enabled: true // Sử dụng pinch để zoom
                                }
                            }
                    }
                }
            }
        });

        // Hàm cập nhật biểu đồ với dữ liệu mới
        function updateChart(data) {
            const currentTime = new Date(data.date);
                const price = data.now;

                // Thêm dữ liệu mới vào biểu đồ
                lineChart.data.labels.push(currentTime);
                lineChart.data.datasets[0].data.push(price);

                // Cập nhật biểu đồ
                lineChart.update();
        }

        const socket = new WebSocket('ws://localhost/websocket/');
    
        // Khi kết nối được mở
        socket.addEventListener('open', function (event) {
            console.log('Connected to WebSocket server');
            // Tạo thông điệp yêu cầu dữ liệu chứng khoán
            // chuyển đổi thông điệp sang JSON và gửi đi
            socket.send('hello from client');
        });
    
        // Khi nhận được tin nhắn từ server
        socket.addEventListener('message', async function (event) {
            try {
                // Chuyển đổi Buffer thành chuỗi
                const message = event.data instanceof Blob ? await event.data.text() : event.data;
                console.log('Đã nhận dữ liệu từ server:', message);
    
                // Giả sử message là một mảng JSON
                const data = JSON.parse(message);
                // Cập nhật biểu đồ với dữ liệu mới
                updateChart(data[0]);
                // data.forEach(function (item) {
                //     // Tạo một thẻ div và thêm vào body
                //     const div = document.createElement('div');
                //     const currentTime = new Date().toLocaleString();
                //     // In ra thông điệp
                //     div.textContent = `[${currentTime}] ${JSON.stringify(item, null, 2)}`;
                //     document.body.appendChild(div);                   
                // });
            } catch (error) {
                console.error('Error processing message:', error);
            }
        });
    
        // Khi kết nối bị đóng
        socket.addEventListener('close', function (event) {
            console.log('Disconnected from WebSocket server');
        });
    
        // Khi có lỗi xảy ra
        socket.addEventListener('error', function (event) {
            console.error('WebSocket Error:', event);
        });
    </script>
</body>
</html>